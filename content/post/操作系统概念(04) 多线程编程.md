---
title: "操作系统概念(04) 多线程编程"
date: 2021-06-23T10:19:06+08:00
draft: false
---

# 多线程编程



## 1. 概述

线程是CPU使用的基本单元。它包括线程ID、程序计数器、寄存器组和堆栈。

一个繁忙的web服务器，可能有多个（可能上千个）客户端并发访问它。怎么解决？

- 多进程。服务器收到请求后，创建另一个进程以便处理请求。缺点：耗费时间和资源。
- 多线程。创建新线程以处理请求。

在远程过程调用中，RPC服务器通常也是多线程的。当服务器收到消息，它使用一个单独线程处理消息。这允许服务器处理多个并发请求。

优点：

- 响应性：增加响应效率。
- 资源共享：进程只能通过共享内存，消息传递来共享资源。这些需要程序员显示的安排。不过，线程默认共享它所属的进程的资源和内存。
- 经济：创建进程开销昂贵。对于Solaris，创建进程要比线程慢30倍，切换进程要比线程慢5倍。
- 可伸缩性：对于多处理器体系结构，多线程可以在多核并行运行。



## 2. 多核编程

无论多个计算核在在多个CPU芯片上还是单个CPU芯片上，我们都称之为多核系统。

<img src="https://cdn.jsdelivr.net/gh/qiaocci/img-repo@master/20210623144433.png" style="zoom:50%;" />

对于多核系统，多个线程能够并行运行。

并发 vs 并行？

- 并发：多个任务交替使用CPU。

- 并行：并行系统可以同时执行多个任务。

并行分为数据并行和任务并行，通常应用程序混合使用两种策略。



## 3. 多线程模型

有两种方法来提供线程支持：用户线程和内核线程。

用户线程位于内核线程之上，它的管理无需内核支持。内核线程由操作系统支持和管理。

用户线程和内核线程的三种关系：

### 3.1 多对一

多个用户线程对应一个内核线程。

优点：线程管理由用户空间的线程库完成，效率更高。

缺点：第一，如果一个西安城执行阻塞系统调用，整个进程将会阻塞。第二，因为任一时间只有一个线程可以访问内核，所以多个线程不能并行运行在多处理器系统上。

现在几乎没有系统使用这个模型。

<img src="https://cdn.jsdelivr.net/gh/qiaocci/img-repo@master/20210623145649.png" style="zoom: 50%;" />

### 3.2 一对一

每个用户线程映射到一个内核线程。

优点：第一，更好的并发性：当一个线程执行阻塞系统调用时，允许另一个线程继续执行。第二，允许多个线程并行运行在多处理器系统。

缺点：创建一个用户线程就要创建一个内核线程，开销大，限制了系统支持的线程数量

### 3.3 多对多

多个用户线程多路复用到多个内核线程。

优点：第一，用户可以创建人一多用户线程，并且内核线程能在多个处理器系统上并发执行。第二，当一个线程执行阻塞系统调用时，内核可以调度另一个线程来执行。

<img src="https://cdn.jsdelivr.net/gh/qiaocci/img-repo@master/20210623163055.png" style="zoom: 50%;" />

